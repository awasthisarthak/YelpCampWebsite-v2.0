const fs = require('fs');
const path = require('path');

function parse(src) {
  const result = {};
  src.split('\n').forEach(line => {
    const match = line.match(/^\s*([\w.-]+)\s*=\s*(.*)\s*$/);
    if (match) {
      const key = match[1];
      let value = match[2] || '';
      if (value.startsWith('"') && value.endsWith('"')) {
        value = value.slice(1, -1);
      }
      result[key] = value;
    }
  });
  return result;
}

exports.config = function(options = {}) {
  const envPath = options.path || path.resolve(process.cwd(), '.env');
  if (!fs.existsSync(envPath)) {
    return { parsed: {} };
  }
  const parsed = parse(fs.readFileSync(envPath, 'utf8'));
  for (const k in parsed) {
    if (process.env[k] === undefined) {
      process.env[k] = parsed[k];
    }
  }
  return { parsed };
};
